<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home Workout Tracker</title>
  <meta name="description" content="Home workout tracker with per-rep checkmarks, progress percent, and calendar. Sign in with Google." />
  <link rel="icon" type="image/png" href="logo.png" />
  <style>
    :root{
      --bg:#05060a; --card:#0b1220; --muted:#9aa4b2; --accent:#00d4ff; --accent2:#7c3aed;
      --glass:rgba(255,255,255,0.03); --glass-2:rgba(255,255,255,0.02);
      --radius:14px; --maxw:980px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      color:#e6eef8;
      background:radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.08), transparent),
                 linear-gradient(180deg,#03040a 0%, #071428 70%);
      -webkit-font-smoothing:antialiased
    }
    .wrap{max-width:var(--maxw);margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:800;color:#001;letter-spacing:0.6px}
    h1{margin:0;font-size:1.25rem}
    .muted{color:var(--muted);font-size:0.95rem}

    main{background:linear-gradient(180deg,var(--glass),transparent);padding:18px;border-radius:18px;box-shadow:0 8px 40px rgba(2,6,23,0.6)}

    .top{display:flex;gap:18px;align-items:center}
    .session-card{flex:1;background:var(--card);padding:14px;border-radius:12px}
    .controls{display:flex;gap:10px;align-items:center}

    form.add{display:flex;gap:8px;flex-wrap:wrap}
    input,select,button,textarea{
      padding:10px;
      border-radius:10px;
      border:0;
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      color:inherit;
      font-family:inherit;
    }
    input[type='number']{width:90px}
    input[type='date']{width:180px}
    .btn{cursor:pointer;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--accent2),var(--accent));color:#001}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    .input-error{outline:2px solid rgba(255,77,79,0.9);box-shadow:0 4px 18px rgba(255,77,79,0.12);} 

    .ex-list{margin-top:14px;display:flex;flex-direction:column;gap:10px}
    .exercise{display:grid;grid-template-columns:1fr auto;gap:12px;padding:10px;border-radius:12px;background:linear-gradient(180deg,var(--glass),var(--glass-2));align-items:center;}
    .exercise .meta{display:flex;flex-direction:column}
    .exercise .reps{display:flex;flex-direction:row;flex-wrap:wrap;gap:8px;justify-content:flex-start;align-items:center;max-width:650px}
    .rep{width:28px;height:28px;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .rep input{width:18px;height:18px}
    .rep.done{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001}

    .ex-opts{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .small{font-size:0.9rem;color:var(--muted)}

    .progress{margin-top:10px}
    .progress-bar{height:12px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden}
    .progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 260ms ease}

    .calendar{margin-left:18px;width:260px;background:linear-gradient(180deg,var(--glass),transparent);padding:10px;border-radius:12px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-day{height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;background:rgba(255,255,255,0.01);cursor:pointer}
    .cal-day.checked{background:linear-gradient(90deg,var(--accent2),var(--accent));color:#001}
    .cal-day.selected{outline:2px solid rgba(124,58,237,0.6)}

    footer{margin-top:18px;color:var(--muted);font-size:0.9rem;text-align:center}

    /* LIGHT THEME OVERRIDES */
    body.light{
      color:#020617;
      background:radial-gradient(1200px 600px at 10% 10%, rgba(59,130,246,0.15), transparent),
                 linear-gradient(180deg,#f9fafb 0%, #e5e7eb 70%);
    }
    body.light .muted{color:#6b7280}
    body.light main{background:#ffffff;box-shadow:0 12px 45px rgba(15,23,42,0.08);}
    body.light .session-card{background:#f9fafb;}
    body.light .calendar{background:#f3f4f6;}
    body.light .exercise{background:#e5e7eb;}
    body.light .btn-primary{background:linear-gradient(90deg,#2563eb,#0ea5e9);color:#f9fafb;}
    body.light .cal-day{background:#e5e7eb;}
    body.light .cal-day.checked{background:linear-gradient(90deg,#4f46e5,#0ea5e9);color:#f9fafb;}
    body.light .progress-bar{background:#e5e7eb;}

    /* Mobile: show calendar above the session card */
    @media (max-width:880px){
      .top { flex-direction: column; }
      .calendar {
        order: -1;
        width: 100%;
        margin-left: 0;
        margin-bottom: 12px;
      }
      .session-card { order: 0; }

      header .controls { gap: 6px; }

      .top .session-card, .top .calendar { padding: 12px; }
    }

    .completion{
      font-size:1rem;
      color:var(--muted);
      display:flex;
      align-items:baseline;
      gap:6px;
    }

    .completion .label{
      font-size:0.9rem;
    }

    .completion #percent{
      font-size:1.6rem;
      font-weight:800;
      letter-spacing:0.03em;
      color: rgb(126, 0, 222);
    }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">H</div>
        <div>
          <h1>Home Workout Tracker</h1>
          <div class="muted">Sync across devices with Google</div>
        </div>
      </div>
      <div class="controls">
        <button id="themeToggle" type="button" class="btn btn-ghost" title="Toggle dark/light mode">â˜€</button>
        <div id="userInfo" class="muted">Not signed in</div>
        <button id="signBtn" type="button" class="btn btn-primary">Sign in with Google</button>
      </div>
    </header>

    <main>
      <div class="top">
        <div class="session-card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Session</div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
                <div class="muted" id="sessionDate"></div>
                <input id="sessionDateInput" type="date" title="Select session date (choose future dates to pre-plan)" />
                <div class="muted small">(pick a date to plan or view)</div>
              </div>
            </div>
            <div class="completion">
            <span class="label">Completion:</span>
            <span id="percent">0%</span>
            </div>
          </div>

          <!-- novalidate prevents browser validation popups -->
          <form id="addForm" class="add" onsubmit="return false;" novalidate style="margin-top:12px">
            <input id="exName" placeholder="Exercise name" />
            <input id="exReps" type="number" min="1" value="10" placeholder="Reps" title="Reps per set" />
            <input id="exSets" type="number" min="1" value="4" placeholder="Sets" title="Number of sets (checkboxes)" />
            <button id="addBtn" type="button" class="btn btn-ghost">Add</button>
            <button id="repeatYesterdayBtn" type="button" class="btn btn-ghost">Repeat yesterday</button>
            <button id="clearBtn" type="button" class="btn" style="background:transparent;color:var(--muted)">Clear</button>
          </form>

          <div class="ex-list" id="exList"></div>

          <div class="progress" aria-hidden>
            <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
          </div>

        </div>

        <aside class="calendar" aria-label="Calendar">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:800">Check-ins</div>
            <div style="display:flex;gap:6px">
              <button id="prevMonth" type="button" class="btn">â—€</button>
              <button id="nextMonth" type="button" class="btn">â–¶</button>
            </div>
          </div>
          <div id="calMonth" class="muted" style="margin-bottom:8px"></div>
          <div class="cal-grid" id="calGrid"></div>
        </aside>
      </div>

      <footer>
        <div>Tip: Pick a future date using the date picker to pre-plan exercises. Sign in with Google to sync across devices.</div>

        <!-- moved Export/Import controls to bottom to avoid header crowding on mobile -->
        <div class="mobile-utils" style="margin-top:12px">
          <input id="importFile" type="file" accept="application/json" style="display:none" />
          <button id="exportBtn" type="button" title="Export session JSON" class="btn">Export</button>
          <button id="importBtn" type="button" title="Import session JSON" class="btn">Import</button>
        </div>
      </footer>
    </main>
  </div>

  <script>
    /***** FIREBASE CONFIGURATION (REPLACE WITH YOURS) *****/
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCHTi8h6yEO1f3V02Ztu-fsdxAXtIWoq0o",
      authDomain: "workoutdb-9e226.firebaseapp.com",
      projectId: "workoutdb-9e226",
      storageBucket: "workoutdb-9e226.firebasestorage.app",
      messagingSenderId: "443315512590",
      appId: "1:443315512590:web:d7e1d285d62db61682a35f"
    };

    /***** Minimal app state & utils *****/
    let currentUser = null; // { uid, name, email }
    function pad(n){return String(n).padStart(2,'0');}
    const today = new Date();
    let sessionDate = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;

    // calendar view month/year (used for prev/next month buttons)
    let calView = { year: (new Date()).getFullYear(), month: (new Date()).getMonth() };

    const state = { exercises: [] } // exercises: [{id,name,reps (sets),repsPerSet, repsState: [bool...] }]

    // DOM refs
    const el = id=>document.getElementById(id);
    const exList = el('exList'), percentEl = el('percent'), progressFill = el('progressFill'), sessionDateEl = el('sessionDate');
    const importFile = el('importFile'); const sessionDateInput = el('sessionDateInput');

    // THEME
    const THEME_KEY = 'hwTheme';

    function applyTheme(theme){
      if(theme === 'light'){
        document.body.classList.add('light');
      }else{
        document.body.classList.remove('light');
      }
      const btn = el('themeToggle');
      if(btn){
        // Show the *target* of next click
        const isLight = document.body.classList.contains('light');
        btn.textContent = isLight ? 'ðŸŒ™' : 'â˜€';
      }
    }

    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY) || 'dark';
      applyTheme(saved);
      const btn = el('themeToggle');
      if(btn){
        btn.addEventListener('click', ()=>{
          const isLight = document.body.classList.contains('light');
          const next = isLight ? 'dark' : 'light';
          localStorage.setItem(THEME_KEY, next);
          applyTheme(next);
        });
      }
    }

    // date helpers
    function strToDate(str){
      const [y,m,d] = str.split('-').map(Number);
      return new Date(y, m-1, d);
    }
    function dateToStr(d){
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function offsetDateStr(str, deltaDays){
      const d = strToDate(str);
      d.setDate(d.getDate() + deltaDays);
      return dateToStr(d);
    }

    // setSessionDate now safely parses YYYY-MM-DD (no timezone shifts)
    function setSessionDate(d){
      sessionDate = d;
      const display = strToDate(d);
      sessionDateEl.textContent = display.toLocaleDateString();
      sessionDateInput.value = d; // reload state for that date
      loadState(); render(); updateCalendar();
    }

    // initialize display values
    (function(){
      const display = strToDate(sessionDate);
      sessionDateEl.textContent = display.toLocaleDateString();
      sessionDateInput.value = sessionDate;
    })();

    // --- Persistence layer (Firestore if configured; otherwise localStorage) ---
    let useFirestore = false; let db=null; let auth=null;
    let _saveTimer = null;

    async function initFirebaseIfNeeded(){
      if(window.__firebaseInited) return; window.__firebaseInited = true;
      if(!FIREBASE_CONFIG) return;
      try{
        await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js');
        await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js');
        await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js');
        const app = firebase.initializeApp(FIREBASE_CONFIG);
        auth = firebase.auth(); db = firebase.firestore(); useFirestore = true;
        auth.onAuthStateChanged(u=>{
          if(u) onUserSignIn(u); else onUserSignOut();
        });
      }catch(e){console.warn('Firebase init failed',e); useFirestore = false;}    
    }

    function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s)})}

    // normalization so old data still works
    function normalizeExercises(list){
      if(!Array.isArray(list)) return [];
      return list.map(ex=>{
        const reps = Number(ex.reps) || 0; // here reps = number of sets (checkboxes)
        const srcState = Array.isArray(ex.repsState) ? ex.repsState : [];
        const repsState = Array(reps).fill(false).map((_,i)=>!!srcState[i]);
        let repsPerSet = ex.repsPerSet;
        if(repsPerSet !== undefined && repsPerSet !== null && repsPerSet !== ''){
          repsPerSet = Number(repsPerSet);
          if(Number.isNaN(repsPerSet)) repsPerSet = undefined;
        }else{
          repsPerSet = undefined;
        }
        return {
          id: ex.id || (Date.now().toString(36)+Math.random().toString(36).slice(2,7)),
          name: ex.name || 'Exercise',
          reps,              // number of sets
          repsPerSet,        // reps per set (for label)
          repsState
        };
      });
    }

    // Local persistence keys
    function storageKeyForUser(uid, date){ return `hw:${uid||'local'}:${date}` }

    async function loadState(){
      state.exercises = [];
      // if using firestore & signed in, try loading
      if(useFirestore && currentUser){
        try{
          const doc = await db.collection('sessions').doc(currentUser.uid).collection('days').doc(sessionDate).get();
          if(doc.exists){ 
            const data = doc.data(); 
            if(data && Array.isArray(data.exercises)){
              state.exercises = normalizeExercises(data.exercises);
              render(); return; 
            }
          }
        }catch(e){console.warn(e)}
      }
      // fallback: localStorage
      const raw = localStorage.getItem(storageKeyForUser(currentUser?currentUser.uid:null, sessionDate));
      if(raw){ 
        try{ 
          const parsed = JSON.parse(raw); 
          if(parsed && Array.isArray(parsed.exercises)) state.exercises = normalizeExercises(parsed.exercises);
        }catch(e){} 
      }
      render();
    }

    // Save session also to date-key for calendar lookups
    async function doSave(){
      const key = storageKeyForUser(currentUser?currentUser.uid:null, sessionDate);
      try{ localStorage.setItem(key, JSON.stringify(state)); }catch(e){console.warn('localStorage save failed',e)}
      if(useFirestore && currentUser){
        try{ await db.collection('sessions').doc(currentUser.uid).collection('days').doc(sessionDate).set(state); }catch(e){console.warn('save failed',e)}
      }
      updateCalendar();
    }
    function saveState(immediate=false){
      if(_saveTimer) clearTimeout(_saveTimer);
      if(immediate){ doSave(); return; }
      _saveTimer = setTimeout(()=>{ doSave(); _saveTimer = null; }, 350);
    }

    // --- UI / behavior ---
    // Helper: update only progress UI (no full DOM rebuild)
    function updateProgressUI(){
      // progress based on completed sets (checkboxes)
      let total = 0, done = 0;
      state.exercises.forEach(ex=>{
        total += ex.reps || 0; // number of sets
        done += (ex.repsState || []).filter(Boolean).length;
      });
      const pct = total ? Math.round(done/total*100) : 0;
      percentEl.textContent = pct + '%';
      progressFill.style.width = pct + '%';
    }

    // render + stable handlers
    function render(){
      exList.innerHTML = '';

      state.exercises.forEach(ex=>{
        const exId = ex.id;
        const wrap = document.createElement('div'); wrap.className = 'exercise';
        const left = document.createElement('div'); left.className = 'meta';

        let titleText = ex.name;
        let subText;
        if(ex.repsPerSet){
          titleText = `${ex.name} (${ex.repsPerSet} reps)`;
          subText = `${ex.reps} sets`;
        }else{
          // old data fallback
          titleText = ex.name;
          subText = `${ex.reps} reps`;
        }

        const title = document.createElement('div'); title.style.fontWeight='800'; title.textContent = titleText;
        const small = document.createElement('div'); small.className='muted'; small.textContent = subText;
        left.appendChild(title); left.appendChild(small);

        const right = document.createElement('div'); right.className='ex-opts';
        const repsWrap = document.createElement('div'); repsWrap.className='reps';

        // ex.reps = number of sets (checkboxes)
        for(let i=0;i<ex.reps;i++){
          const repWrap = document.createElement('div'); repWrap.className='rep';
          repWrap.dataset.exId = exId;
          repWrap.dataset.repIndex = i;

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = !!(ex.repsState && ex.repsState[i]);
          checkbox.setAttribute('aria-label', `Set ${i+1} for ${ex.name}`);

          repWrap.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            toggleRepById(exId, i);
          });

          checkbox.addEventListener('change', (ev)=>{
            ev.stopPropagation();
            const desired = !!checkbox.checked;
            const idx = state.exercises.findIndex(e => e.id === exId);
            if(idx===-1) return;
            const exm = state.exercises[idx];
            if(!Array.isArray(exm.repsState)) exm.repsState = Array(exm.reps).fill(false);
            if(!!exm.repsState[i] === desired) return;
            exm.repsState[i] = desired;
            if(desired) repWrap.classList.add('done'); else repWrap.classList.remove('done');
            updateProgressUI();
            saveState(false);
          });

          repWrap.appendChild(checkbox);
          if(ex.repsState && ex.repsState[i]) repWrap.classList.add('done');
          repsWrap.appendChild(repWrap);
        }

        const del = document.createElement('button'); del.type='button'; del.className='btn'; del.textContent='Delete';
        del.dataset.id = exId;
        del.addEventListener('click', (ev)=>{
          ev.stopPropagation(); const id = ev.currentTarget.dataset.id;
          const realIdx = state.exercises.findIndex(s=>s.id===id);
          if(realIdx===-1) return;
          if(confirm('Remove this exercise?')){
            state.exercises.splice(realIdx,1);
            saveState(true);
            render();
          }
        });

        const comp = document.createElement('button'); comp.type='button'; comp.className='btn btn-ghost'; comp.textContent='Complete';
        comp.dataset.id = exId;
        comp.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          const id = ev.currentTarget.dataset.id;
          const realIdx = state.exercises.findIndex(s=>s.id===id);
          if(realIdx===-1) return;
          const e = state.exercises[realIdx];
          e.repsState = Array(e.reps).fill(true);
          saveState(true);
          render();
        });

        const edit = document.createElement('button'); edit.type='button'; edit.className='btn'; edit.textContent='Edit';
        edit.dataset.id = exId;
        edit.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          const id = ev.currentTarget.dataset.id;
          const realIdx = state.exercises.findIndex(s=>s.id===id);
          if(realIdx===-1) return;
          const exObj = state.exercises[realIdx];

          const newName = prompt('Exercise name', exObj.name);
          if(newName === null) return;

          const currentRepsPerSet = exObj.repsPerSet || 10;
          const repsPerSetInput = prompt('Reps per set', currentRepsPerSet);
          if(repsPerSetInput === null) return;
          const newRepsPerSet = parseInt(repsPerSetInput);

          const setsInput = prompt('Number of sets', exObj.reps || 4);
          if(setsInput === null) return;
          const newSets = parseInt(setsInput);

          if(!newName.trim()) return alert('Invalid name');
          if(isNaN(newRepsPerSet) || newRepsPerSet < 1) return alert('Invalid reps per set');
          if(isNaN(newSets) || newSets < 1) return alert('Invalid number of sets');

          exObj.name = newName.trim();
          exObj.repsPerSet = newRepsPerSet;
          if(newSets !== exObj.reps){
            exObj.reps = newSets;
            exObj.repsState = Array(newSets).fill(false);
          }
          saveState(true);
          render();
        });

        right.appendChild(repsWrap);
        right.appendChild(comp);
        right.appendChild(edit);
        right.appendChild(del);

        wrap.appendChild(left);
        wrap.appendChild(right);
        exList.appendChild(wrap);
      });

      updateProgressUI();
    }

    // toggle by stable id
    function toggleRepById(exId, repIdx){
      const idx = state.exercises.findIndex(e => e.id === exId);
      if(idx === -1) return;
      const ex = state.exercises[idx];
      if(!Array.isArray(ex.repsState)) ex.repsState = Array(ex.reps).fill(false);

      ex.repsState[repIdx] = !ex.repsState[repIdx];

      const nodes = exList.children;
      for(let n=0;n<nodes.length;n++){
        const node = nodes[n];
        const repNodes = node.querySelectorAll('.rep');
        if(!repNodes || !repNodes.length) continue;
        if(repNodes[0] && repNodes[0].dataset && repNodes[0].dataset.exId === exId){
          const target = repNodes[repIdx];
          if(target){
            if(ex.repsState[repIdx]) target.classList.add('done');
            else target.classList.remove('done');

            const cb = target.querySelector('input[type="checkbox"]');
            if(cb && cb.checked !== !!ex.repsState[repIdx]) cb.checked = !!ex.repsState[repIdx];
          }
          break;
        }
      }

      updateProgressUI();
      saveState(false);
    }

    // add exercise
    el('addBtn').addEventListener('click', ()=>{
      const name = el('exName').value.trim();
      const repsPerSet = parseInt(el('exReps').value) || 0;
      const sets = parseInt(el('exSets').value) || 0;

      if(!name || repsPerSet<=0 || sets<=0){
        if(!name) el('exName').classList.add('input-error'); else el('exName').classList.remove('input-error');
        if(repsPerSet<=0) el('exReps').classList.add('input-error'); else el('exReps').classList.remove('input-error');
        if(sets<=0) el('exSets').classList.add('input-error'); else el('exSets').classList.remove('input-error');
        return;
      }

      const ex = {
        id: Date.now().toString(36),
        name,
        reps: sets,                    // reps = number of sets (checkboxes)
        repsPerSet: repsPerSet,        // reps per set (label)
        repsState: Array(sets).fill(false)
      };
      state.exercises.push(ex);

      el('exName').value='';
      el('exReps').value=10;
      el('exSets').value=4;
      el('exName').classList.remove('input-error');
      el('exReps').classList.remove('input-error');
      el('exSets').classList.remove('input-error');

      saveState(true);
      render();
    });

    // Repeat yesterday feature
    async function loadExercisesForDate(dateStr){
      let exercises = [];
      if(useFirestore && currentUser){
        try{
          const doc = await db.collection('sessions').doc(currentUser.uid).collection('days').doc(dateStr).get();
          if(doc.exists){
            const data = doc.data();
            if(data && Array.isArray(data.exercises)){
              exercises = normalizeExercises(data.exercises);
            }
          }
        }catch(e){console.warn(e);}
      }
      if(!exercises.length){
        const raw = localStorage.getItem(storageKeyForUser(currentUser?currentUser.uid:null, dateStr));
        if(raw){
          try{
            const parsed = JSON.parse(raw);
            if(parsed && Array.isArray(parsed.exercises)){
              exercises = normalizeExercises(parsed.exercises);
            }
          }catch(e){}
        }
      }
      return exercises;
    }

    el('repeatYesterdayBtn').addEventListener('click', async ()=>{
    const yStr = offsetDateStr(sessionDate, -1);
    let exercises = await loadExercisesForDate(yStr);
    if(!exercises.length){
      alert('No exercises found for yesterday.');
      return;
    }
    const humanDate = strToDate(yStr).toLocaleDateString();
    if(!confirm(`Replace current exercises with those from ${humanDate}?`)) return;

    // Copy only structure; reset all progress
    exercises = exercises.map(ex => ({
      id: Date.now().toString(36) + Math.random().toString(36).slice(2,7), // new ids
      name: ex.name,
      reps: ex.reps,                    // number of sets
      repsPerSet: ex.repsPerSet,        // reps per set
      repsState: Array(ex.reps).fill(false) // all checkboxes unchecked
    }));

    state.exercises = exercises;
    saveState(true);
    render();
  }); 

    

    el('clearBtn').addEventListener('click', ()=>{ if(confirm('Clear all exercises for this day?')){ state.exercises=[]; saveState(true); render(); } });

    el('exName').addEventListener('input', ()=>{ el('exName').classList.remove('input-error'); });
    el('exReps').addEventListener('input', ()=>{ el('exReps').classList.remove('input-error'); });
    el('exSets').addEventListener('input', ()=>{ el('exSets').classList.remove('input-error'); });

    // calendar
    function updateCalendar(viewYear=calView.year, viewMonth=calView.month){
      const grid = el('calGrid'); grid.innerHTML='';
      const year = viewYear, month = viewMonth;
      el('calMonth').textContent = new Date(year,month,1).toLocaleString(undefined,{month:'long',year:'numeric'});
      const first = new Date(year,month,1).getDay(); const days = new Date(year,month+1,0).getDate();

      for(let i=0;i<first;i++){ const d=document.createElement('div'); d.className='cal-day'; grid.appendChild(d); }
      for(let d=1;d<=days;d++){
        const day = document.createElement('div'); day.className='cal-day'; day.textContent = d;
        const keyDate = `${String(year).padStart(4,'0')}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const checked = checkinExistsForDate(keyDate);
        if(checked) day.classList.add('checked');
        day.addEventListener('click', ()=>{ setSessionDate(keyDate); });
        grid.appendChild(day);
      }
      highlightCalendarSelection();
    }

    function highlightCalendarSelection(){
      const grid = el('calGrid'); if(!grid) return; const children = grid.querySelectorAll('.cal-day'); children.forEach(c=>c.classList.remove('selected'));
      const dayNum = Number(sessionDate.split('-')[2]);
      const items = grid.querySelectorAll('.cal-day');
      items.forEach(item=>{ if(Number(item.textContent)===dayNum) item.classList.add('selected'); });
    }

    function checkinExistsForDate(d){
      const key = storageKeyForUser(currentUser?currentUser.uid:null, d);
      try{
        const raw = localStorage.getItem(key);
        if(raw){
          const s=JSON.parse(raw);
          return (s.exercises||[]).some(ex=> (ex.repsState||[]).some(Boolean));
        }
      }catch(e){}
      return false;
    }

    el('prevMonth').addEventListener('click', ()=>{ calView.month--; if(calView.month<0){ calView.month=11; calView.year--; } updateCalendar(); });
    el('nextMonth').addEventListener('click', ()=>{ calView.month++; if(calView.month>11){ calView.month=0; calView.year++; } updateCalendar(); });

    sessionDateInput.addEventListener('change', (e)=>{
      const v = e.target.value; if(!v) return; setSessionDate(v);
    });

    // export/import
    el('exportBtn').addEventListener('click', ()=>{
      const payload = { date: sessionDate, exercises: state.exercises };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `hw-session-${sessionDate}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    el('importBtn').addEventListener('click', ()=> importFile.click());
    importFile.addEventListener('change', (ev)=>{
      const f = ev.target.files[0]; if(!f) return; const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const parsed = JSON.parse(reader.result);
          if(parsed && Array.isArray(parsed.exercises)){
            if(confirm('Replace current session with imported data?')){
              state.exercises = normalizeExercises(parsed.exercises);
              if(parsed.date) setSessionDate(parsed.date); 
              saveState(true); 
              render(); 
            }
          }else alert('Invalid file');
        }catch(e){alert('Invalid JSON');}
      };
      reader.readAsText(f);
      ev.target.value='';
    });

    // auth (optional)
    el('signBtn').addEventListener('click', async ()=>{
      if(!useFirestore){ alert('Firebase not configured. Install your Firebase config in the file to enable Google sign-in and sync.'); return; }
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      }catch(e){console.warn(e)}
    });

    function onUserSignIn(u){
      currentUser = { uid: u.uid, name: u.displayName || u.email, email: u.email };
      el('userInfo').textContent = currentUser.name || currentUser.email;
      el('signBtn').textContent = 'Sign out';
      el('signBtn').removeAttribute('disabled');
      el('signBtn').onclick = ()=>auth.signOut();
      loadState(); render(); updateCalendar();
    }
    function onUserSignOut(){
      currentUser = null;
      el('userInfo').textContent = 'Not signed in';
      el('signBtn').textContent = 'Sign in with Google';
      el('signBtn').onclick = null;
      initAfterAuth();
    }

    async function initAfterAuth(){ await initFirebaseIfNeeded(); await loadState(); render(); }

    (async ()=>{
      initTheme();
      await initFirebaseIfNeeded();
      await loadState(); 
      render(); 
      updateCalendar();
    })();

  </script>
</body>
</html>
