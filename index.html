<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home Workout Tracker</title>
  <meta name="description" content="Home workout tracker - single-file app with localStorage, import/export, date planning, and accessible controls." />
  <style>
    :root{--bg:#f7f8fb;--card:#fff;--muted:#666;--accent:#2563eb;--danger:#ef4444}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; background:var(--bg); color:#111}
    .container{max-width:920px;margin:28px auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(37,99,235,0.12)}
    .btn.danger{background:var(--danger)}
    .small{padding:6px 8px;font-size:13px}
    .muted{color:var(--muted)}

    /* Layout */
    .main{display:grid;grid-template-columns:1fr 320px;gap:18px;margin-top:12px}
    @media (max-width:920px){.main{grid-template-columns:1fr}}

    /* left column */
    .left .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    #itemsList{margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.03)}
    .item label{flex:1;cursor:pointer}
    .item .meta{font-size:12px;color:var(--muted)}

    /* right column */
    .right .section{margin-bottom:12px}
    .stat{font-size:28px;font-weight:600}

    /* Add form */
    #addForm{display:flex;gap:8px;align-items:center;margin-top:8px}
    #addForm input[type="text"]{flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef}

    /* popup/session */
    #sessionPopup{position:fixed;right:18px;bottom:18px;background:var(--card);padding:12px;border-radius:10px;box-shadow:0 8px 30px rgba(15,23,42,.08);z-index:1200}
    #sessionPopup.hidden{display:none}

    /* export/import bottom on mobile */
    .export-import{display:inline-flex;gap:8px}
    @media (max-width:600px){
      .export-import{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:1100;padding:8px;background:rgba(255,255,255,0.92);border-radius:12px;box-shadow:0 8px 24px rgba(15,23,42,.06)}
    }

    /* accessibility focus */
    .btn:focus, input:focus, select:focus, button:focus{outline:3px solid rgba(37,99,235,.14);outline-offset:2px}
    input[type='checkbox']{width:18px;height:18px}

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display:flex;align-items:center;gap:12px">
        <h1>Home Workout Tracker</h1>
        <div class="muted">Plan, track & export your sessions</div>
      </div>

      <div class="controls">
        <button id="googleSignIn" class="btn ghost small" aria-disabled="false">Sign in with Google</button>
        <div class="export-import">
          <button id="exportBtn" class="btn small">Export JSON</button>
          <label for="importFile" class="btn small ghost" style="margin:0;cursor:pointer">Import</label>
          <input id="importFile" type="file" accept="application/json" style="display:none">
          <button id="resetBtn" class="btn small danger">Reset Data</button>
        </div>
      </div>
    </header>

    <main class="main">
      <section class="left card">
        <div class="toolbar">
          <label for="datePicker">Date</label>
          <input id="datePicker" type="date" aria-label="Select date">

          <button id="copyFromPrev" class="btn small ghost">Copy from previous</button>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <div class="muted">Completion</div>
            <div id="completion" class="stat">0%</div>
          </div>
        </div>

        <div>
          <div style="display:flex;align-items:center;justify-content:space-between">
            <strong>Exercises</strong>
            <div class="muted">Check to mark done</div>
          </div>

          <div id="itemsList" aria-live="polite" aria-atomic="true"></div>

          <div id="addForm">
            <input id="newExercise" type="text" placeholder="New exercise (e.g. Push-ups)" aria-label="New exercise name">
            <button id="addBtn" class="btn small">Add</button>
            <button id="clearDone" class="btn small ghost">Clear done</button>
          </div>
        </div>
      </section>

      <aside class="right">
        <div class="card section">
          <strong>Session & tips</strong>
          <p class="muted" id="sessionHint">Pick a date to plan exercises. Use Export/Import to backup your data.</p>
        </div>

        <div class="card section">
          <strong>Data tools</strong>
          <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
            <button id="exportBtn2" class="btn small">Export JSON (alt)</button>
            <button id="showRaw" class="btn small ghost">Show raw data</button>
            <div id="rawDataContainer" style="display:none;margin-top:8px;max-height:220px;overflow:auto;font-family:monospace;font-size:12px;background:#fafafa;padding:8px;border-radius:8px;border:1px solid #eee"></div>
          </div>
        </div>
      </aside>
    </main>

    <footer class="muted">Built with ❤️ • Local data saved to your browser</footer>
  </div>

  <!-- small persistent dismissible popup -->
  <div id="sessionPopup" class="card" role="dialog" aria-live="polite">
    <div style="display:flex;gap:10px;align-items:center">
      <div style="flex:1">
        <div style="font-weight:600">Quick tip</div>
        <div class="muted">Dismiss this and we won't show it again on this device.</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <button id="dismissPopup" class="btn small ghost">Dismiss</button>
      </div>
    </div>
  </div>

  <script>
    // Simple, single-file app. Data model: localStorage key 'hwt:data' -> {dates: {"2025-11-24": [{id, name, checked}, ...]}}
    const LS_KEY = 'hwt:data';

    // Utilities
    function q(sel, root=document){return root.querySelector(sel)}
    function qa(sel, root=document){return Array.from(root.querySelectorAll(sel))}
    function uid(){ return 'id_'+Math.random().toString(36).slice(2,9) }

    // Debounce helper
    function debounce(fn, delay=120){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), delay); }}

    // Basic data load/save
    function loadData(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || '{"dates":{}}') }catch(e){ console.error('corrupt data', e); localStorage.removeItem(LS_KEY); return {dates:{}} } }
    function saveData(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)) }

    // DOM refs
    const datePicker = q('#datePicker');
    const itemsList = q('#itemsList');
    const completionNode = q('#completion');
    const newExercise = q('#newExercise');
    const addBtn = q('#addBtn');
    const clearDone = q('#clearDone');
    const exportBtn = q('#exportBtn');
    const exportBtn2 = q('#exportBtn2');
    const importFile = q('#importFile');
    const resetBtn = q('#resetBtn');
    const copyFromPrev = q('#copyFromPrev');
    const rawDataContainer = q('#rawDataContainer');
    const showRaw = q('#showRaw');
    const sessionPopup = q('#sessionPopup');
    const dismissPopup = q('#dismissPopup');
    const googleSignIn = q('#googleSignIn');

    // Initialize
    const today = new Date();
    function toISODate(d){ const t = new Date(d); const yyyy = t.getFullYear(); const m = String(t.getMonth()+1).padStart(2,'0'); const dd = String(t.getDate()).padStart(2,'0'); return `${yyyy}-${m}-${dd}` }
    datePicker.value = toISODate(today);

    // If user previously dismissed popup, respect it
    if (localStorage.getItem('hwt:hidePopup') === 'true') sessionPopup.classList.add('hidden');

    // Disable Google sign-in if no backend
    const oauthReady = false; // set true if you wire backend
    if (!oauthReady) {
      googleSignIn.setAttribute('aria-disabled','true');
      googleSignIn.addEventListener('click', e=>{
        e.preventDefault();
        alert('Sign in requires a configured OAuth backend. For this static build the button is disabled.');
      })
    }

    // Helpers: get items for date (ensure array)
    function itemsFor(date){ const data = loadData(); data.dates = data.dates || {}; data.dates[date] = data.dates[date] || []; return data.dates[date] }
    function setItemsFor(date, arr){ const data = loadData(); data.dates = data.dates || {}; data.dates[date] = arr; saveData(data) }

    // Render list (targeted updates only when possible)
    function renderList(){ const date = datePicker.value; const items = itemsFor(date);
      itemsList.innerHTML = '';
      if (!items.length){ itemsList.innerHTML = '<div class="muted" style="padding:12px;border-radius:8px;background:#fff;border:1px dashed #eee">No exercises yet — add one below.</div>'; updateCompletion(); return }

      for (const it of items){
        const row = document.createElement('div'); row.className = 'item'; row.setAttribute('data-id', it.id);
        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !!it.checked; cb.setAttribute('data-item-id', it.id); cb.setAttribute('aria-label', `Mark ${it.name} done`);
        const label = document.createElement('label'); label.textContent = it.name; label.htmlFor = it.id;
        // name and actions
        const meta = document.createElement('div'); meta.className = 'meta'; meta.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><button class="btn small ghost" data-edit-id="${it.id}">Edit</button><button class="btn small ghost" data-del-id="${it.id}">Delete</button></div>`;
        row.appendChild(cb); row.appendChild(label); row.appendChild(meta);
        itemsList.appendChild(row);
      }

      updateCompletion();
    }

    const updateCompletion = debounce(()=>{
      const date = datePicker.value; const items = itemsFor(date);
      const total = items.length; const done = items.filter(i=>i.checked).length;
      const pct = total ? Math.round((done/total)*100) : 0;
      completionNode.textContent = pct + '%';
    }, 60);

    // event delegation for checkbox toggle and edit/delete
    itemsList.addEventListener('click', (e)=>{
      const cb = e.target.closest('input[type="checkbox"]');
      if (cb){ e.stopPropagation(); const id = cb.getAttribute('data-item-id'); toggleChecked(id, cb.checked); return }
      const editBtn = e.target.closest('button[data-edit-id]');
      if (editBtn){ const id = editBtn.getAttribute('data-edit-id'); editItem(id); return }
      const delBtn = e.target.closest('button[data-del-id]');
      if (delBtn){ const id = delBtn.getAttribute('data-del-id'); deleteItem(id); return }
    });

    // toggle checked without re-rendering entire app (we re-render list to keep DOM coherent but updates are fast)
    function toggleChecked(id, checked){ const date = datePicker.value; const items = itemsFor(date);
      const idx = items.findIndex(x=>x.id===id); if (idx===-1) return; items[idx].checked = checked; setItemsFor(date, items); updateCompletion(); }

    function editItem(id){ const date = datePicker.value; const items = itemsFor(date); const idx = items.findIndex(x=>x.id===id); if (idx===-1) return; const newName = prompt('Edit exercise name', items[idx].name); if (newName && newName.trim()){ items[idx].name = newName.trim(); setItemsFor(date, items); renderList(); } }
    function deleteItem(id){ if (!confirm('Delete this exercise?')) return; const date = datePicker.value; const items = itemsFor(date).filter(x=>x.id!==id); setItemsFor(date, items); renderList(); }

    // Add
    addBtn.addEventListener('click', ()=>{ const name = newExercise.value.trim(); if (!name) { newExercise.focus(); return } const date = datePicker.value; const arr = itemsFor(date); arr.push({id:uid(), name, checked:false}); setItemsFor(date, arr); newExercise.value=''; renderList(); newExercise.focus(); });
    // Enter key on input
    newExercise.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ addBtn.click(); } });

    // Clear done
    clearDone.addEventListener('click', ()=>{ const date = datePicker.value; let items = itemsFor(date); const remain = items.filter(i=>!i.checked); setItemsFor(date, remain); renderList(); });

    // Date change
    datePicker.addEventListener('change', ()=>{ renderList(); });

    // Copy from previous date
    copyFromPrev.addEventListener('click', ()=>{
      const d = new Date(datePicker.value);
      d.setDate(d.getDate()-1);
      const prev = toISODate(d);
      const source = itemsFor(prev) || [];
      if (!source.length){ alert('No items found on previous date'); return }
      // shallow copy items with new ids
      const copy = source.map(s=>({id:uid(), name:s.name, checked:false}));
      if (!confirm(`Copy ${copy.length} items from ${prev} to ${datePicker.value}?`)) return;
      setItemsFor(datePicker.value, copy);
      renderList();
    });

    // Export
    function exportData(){ const data = loadData(); const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'home-workout-data.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    exportBtn.addEventListener('click', exportData); exportBtn2.addEventListener('click', exportData);

    // Import
    importFile.addEventListener('change', (e)=>{
      const f = e.target.files[0]; if (!f) return; const reader = new FileReader(); reader.onload = ()=>{
        try{ const parsed = JSON.parse(reader.result); if (!parsed || typeof parsed !== 'object' || !parsed.dates){ throw new Error('Invalid schema: missing dates') }
          // merge carefully: overwrite only dates present in file
          const cur = loadData(); cur.dates = cur.dates || {};
          for (const k of Object.keys(parsed.dates)){ // sanitize items
            cur.dates[k] = (parsed.dates[k] || []).map(it=>({ id: it.id || uid(), name: String(it.name||'Untitled'), checked: !!it.checked }));
          }
          saveData(cur); alert('Import successful'); renderList();
        }catch(err){ alert('Import failed: ' + (err.message||err)); }
      };
      reader.readAsText(f);
      e.target.value = ''; // reset
    });

    // Reset data (dangerous)
    resetBtn.addEventListener('click', ()=>{ if (!confirm('This will clear all your saved data. Continue?')) return; localStorage.removeItem(LS_KEY); renderList(); });

    // Show raw
    showRaw.addEventListener('click', ()=>{
      const data = loadData(); rawDataContainer.style.display = rawDataContainer.style.display === 'none' ? 'block' : 'none'; rawDataContainer.textContent = JSON.stringify(data, null, 2);
    });

    // Popup dismissal
    dismissPopup.addEventListener('click', ()=>{ sessionPopup.classList.add('hidden'); localStorage.setItem('hwt:hidePopup','true'); });

    // initial render
    renderList();

    // Expose a small safe method for console debugging
    window.hwt = {loadData, saveData, itemsFor, setItemsFor, renderList};

    // accessibility: keyboard support for list (space toggles checkbox)
    itemsList.addEventListener('keydown', (e)=>{
      if (e.key === ' '){ const row = e.target.closest('.item'); if (row){ const id = row.getAttribute('data-id'); const cb = row.querySelector('input[type=checkbox]'); cb.checked = !cb.checked; toggleChecked(id, cb.checked); e.preventDefault(); } }
    });

  </script>
</body>
</html>
